<!-- TODO: Main navigation links (Home, index, tags, ...) --><!-- DoNotFormat -->
<!-- DoNotFormat -->

<html lang='en'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>
    Nix-ifying Rust projects ‚Äì Tristans
  </title>
  
    
      <meta property='og:description' content />
      <meta property='og:site_name' content='Tristans' />
      <meta property='og:type' content='website' />
      <meta property='og:title' content='Nix-ifying Rust projects' />
    
    
      <base href='/' />
      <link href='static/favicon.jpeg' rel='icon' />
    
    <link href='https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-tomorrow.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/combine/npm/prismjs@1.23.0/prism.min.js,npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js'></script>

  
  <link href='tailwind.css?instanceId=a05c8c93-6f16-432f-a73b-95054185a110' rel='stylesheet' type='text/css' />

  <!-- Heist error element -->
  <style type='text/css'>
    strong.error {
      color: lightcoral;
      font-size: 90%;
      font-family: monospace;
    }
  </style>
  <!-- What goes in this file will appear on near the end of <head>--><link rel='preload' href='_emanote-static/fonts/Maven_Pro/MavenPro-VariableFont_wght.ttf' as='font' type='font/ttf' crossorigin />

<style>
  @font-face {
    font-family: 'MavenPro';
    src: url('_emanote-static/fonts/Maven_Pro/MavenPro-VariableFont_wght.ttf') format("truetype");
    font-display: swap;
  }

  body {
    font-family: 'MavenPro', sans-serif;
  }

  a.mavenLinkBold {
    font-variation-settings: 'wght'500;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  header,
  .header-font {
    font-family: 'MavenPro', sans-serif;
  }
</style>

  
    <link rel='stylesheet' href='_emanote-static/inverted-tree.css' />
  
</head>

<!-- DoNotFormat -->



<!-- DoNotFormat -->

<body class='overflow-y-scroll bg-gray-400'>
  
    <div class='container mx-auto max-w-screen-lg'>
      <div class='mt-2 md:mt-4'>
        <!-- DoNotFormat -->
<!-- DoNotFormat -->

<nav id='uptree' class='flipped tree' style='transform-origin: 50%;'>
  <ul class='root'>
    <li>
      
        <ul>
          
            <li>

  <div class='text-gray-900 forest-link'>
    <a href='nix'>
      Nix
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='nixos'>
      NixOS
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='linux'>
      Linux
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='software'>
      <span class='emoji' data-emoji='floppy_disk' style='font-family: emoji'>üíæ</span> Software
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href=''>
      Tristan
    </a>
  </div>

  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='minimalbase'>
      Minimal base
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='tdm/dm/intention'>
      Intention trumps convenience
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='tdm/dm'>
      Digital Minimalism
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='tdm/books'>
      Books
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='tdm'>
      üå± The Digital Minimalist
    </a>
  </div>

  
    <ul>
      
        <li>

  <div class='text-gray-900 forest-link'>
    <a href='systems'>
      <span class='emoji' data-emoji='ringed_planet' style='font-family: emoji'>ü™ê</span> Systems
    </a>
  </div>

  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
          
            <li>

  <div class='text-gray-900 forest-link'>
    <a href='rust'>
      Rust
    </a>
  </div>

  
</li>
          
            <li>

  <div class='text-gray-900 forest-link'>
    <a href='vscode'>
      VSCode
    </a>
  </div>

  
</li>
          
        </ul>
      
    </li>
  </ul>
</nav>
        <div class='md:shadow-2xl md:mb-8'>
          <div class='flex-1 w-full overflow-x-auto bg-white'>
            <main class='px-4 py-4'>
              <h1 class='flex items-end justify-center mb-4 p-3 bg-pink-100 text-5xl font-extrabold text-black rounded'>
  <a class='z-40 tracking-tighter '>
    Nix-ifying Rust projects
  </a>
</h1>
              <article class='overflow-auto'>
  <!-- What goes in this file will appear on top of note body-->
  
    <p class='mb-3'>
      While most would be satisfied with <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>rustup</code>, I wanted to use <a href='nix' class='text-pink-600 mavenLinkBold hover:underline' data-wikilink-type='WikiLinkTag'>Nix</a> for writing any new project in <a href='rust' class='text-pink-600 mavenLinkBold hover:underline' data-wikilink-type='WikiLinkTag'>Rust</a> - especially as I see the value of Nix, and I already use <a href='nixos' class='text-pink-600 mavenLinkBold hover:underline' data-wikilink-type='WikiLinkNormal'>NixOS</a>. It took a bit of digging to evaluate the existing options, and come up with a template Nix setup for new projects.
    </p>
  <div class='ui message'>
    <p class='mb-3'>
      All the code in this post is part of <a href='https://github.com/srid/rust-nix-template' class='text-pink-600 hover:underline' target='_blank' rel='noopener'>rust-nix-template</a> which you can use to bootstrap your Rust project using the Nix approach detailed here. Thanks to <a href='https://old.reddit.com/r/rust/comments/mmbfnj/nixifying_a_rust_project/' class='text-pink-600 hover:underline' target='_blank' rel='noopener'>Alexander Bantyev</a> for the pointers.
    </p>
  </div>
    <p class='mb-3'>
      Let‚Äôs support <a href='https://nixos.wiki/wiki/Flakes' class='text-pink-600 hover:underline' target='_blank' rel='noopener'>Flakes</a> from the get-go. To nixify your Rust project, add the following files to your project <em>and</em> set the <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>name</code> and <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>description</code> fields in <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>flake.nix</code> file appropriately. Then run <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>nix develop</code> to get a nix shell (<code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>nix-shell</code> also works), or <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>nix run</code> to run the app (<code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>nix-build</code> also works).
    </p>
  
    <p class='mb-3'>
      Some points to note:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          We are using the <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>oxalica/rust-overlay</code> overlay to get Rust and friends, because this gives a more recent version than what‚Äôs available in nixpkgs.
        </li>
      
        <li>
          <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>kolloch/crate2nix:tools.nix</code> is like <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>callCabal2nix</code> in Haskell but for Rust projects
        </li>
      
        <li>
          <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>numtide/flake-utils</code> provides Flake utility functions, notably <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>eachDefaultSystem</code>
        </li>
      
        <li>
          <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>edolstra/flake-compat</code> enables us to use our <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>flake.nix</code> to automatically support legacy Nix builders: <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>nix-shell</code> and <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>nix-build</code>.
        </li>
      
        <li>
          The <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>.vscode</code> folder contains all the settings necessary to open the project with full IDE support in <a href='vscode' class='text-pink-600 mavenLinkBold hover:underline' data-wikilink-type='WikiLinkTag'>VSCode</a>, for Rust and Nix (including auto format).
        </li>
      
    </ul>
  <h2 id='flakenix' class='inline-block mt-6 mb-4 text-4xl font-bold text-gray-700 border-b-2'><code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>flake.nix</code></h2><div class='py-0.5 mb-3 text-sm'><pre><code class='nix language-nix'># This file is pretty general, and you can adapt it in your project replacing
# only `name` and `description` below.

{
  description = "...";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
    utils.url = "github:numtide/flake-utils";
    rust-overlay.url = "github:oxalica/rust-overlay";
    crate2nix = {
      url = "github:kolloch/crate2nix";
      flake = false;
    };
    flake-compat = {
      url = "github:edolstra/flake-compat";
      flake = false;
    };
  };

  outputs = { self, nixpkgs, utils, rust-overlay, crate2nix, ... }:
    let
      name = "my-app";
    in
    utils.lib.eachDefaultSystem
      (system:
        let
          # Imports
          pkgs = import nixpkgs {
            inherit system;
            overlays = [
              rust-overlay.overlay
              (self: super: {
                # Because rust-overlay bundles multiple rust packages into one
                # derivation, specify that mega-bundle here, so that crate2nix
                # will use them automatically.
                rustc = self.rust-bin.stable.latest.default;
                cargo = self.rust-bin.stable.latest.default;
              })
            ];
          };
          inherit (import "${crate2nix}/tools.nix" { inherit pkgs; })
            generatedCargoNix;

          # Create the cargo2nix project
          project = pkgs.callPackage
            (generatedCargoNix {
              inherit name;
              src = ./.;
            })
            {
              # Individual crate overrides go here
              # Example: https://github.com/balsoft/simple-osd-daemons/blob/6f85144934c0c1382c7a4d3a2bbb80106776e270/flake.nix#L28-L50
              defaultCrateOverrides = pkgs.defaultCrateOverrides // {
                # The app crate itself is overriden here. Typically we
                # configure non-Rust dependencies (see below) here.
                ${name} = oldAttrs: {
                  inherit buildInputs nativeBuildInputs;
                } // buildEnvVars;
              };
            };

          # Configuration for the non-Rust dependencies
          buildInputs = with pkgs; [ openssl.dev ];
          nativeBuildInputs = with pkgs; [ rustc cargo pkgconfig nixpkgs-fmt ];
          buildEnvVars = {
            PKG_CONFIG_PATH = "${pkgs.openssl.dev}/lib/pkgconfig";
          };
        in
        rec {
          packages.${name} = project.rootCrate.build;

          # `nix build`
          defaultPackage = packages.${name};

          # `nix run`
          apps.${name} = utils.lib.mkApp {
            inherit name;
            drv = packages.${name};
          };
          defaultApp = apps.${name};

          # `nix develop`
          devShell = pkgs.mkShell
            {
              inherit buildInputs nativeBuildInputs;
              RUST_SRC_PATH = "${pkgs.rust.packages.stable.rustPlatform.rustLibSrc}";
            } // buildEnvVars;
        }
      );
}</code></pre></div><h2 id='shellnix' class='inline-block mt-6 mb-4 text-4xl font-bold text-gray-700 border-b-2'><code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>shell.nix</code></h2><div class='py-0.5 mb-3 text-sm'><pre><code class='nix language-nix'>(import
  (
    let
      lock = builtins.fromJSON (builtins.readFile ./flake.lock);
    in
    fetchTarball {
      url = "https://github.com/edolstra/flake-compat/archive/${lock.nodes.flake-compat.locked.rev}.tar.gz";
      sha256 = lock.nodes.flake-compat.locked.narHash;
    }
  )
  {
    src = ./.;
  }).shellNix</code></pre></div><h2 id='defaultnix' class='inline-block mt-6 mb-4 text-4xl font-bold text-gray-700 border-b-2'><code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>default.nix</code></h2><div class='py-0.5 mb-3 text-sm'><pre><code class='nix language-nix'>(import
  (
    let
      lock = builtins.fromJSON (builtins.readFile ./flake.lock);
    in
    fetchTarball {
      url = "https://github.com/edolstra/flake-compat/archive/${lock.nodes.flake-compat.locked.rev}.tar.gz";
      sha256 = lock.nodes.flake-compat.locked.narHash;
    }
  )
  {
    src = ./.;
  }).defaultNix</code></pre></div><h2 id='vscode' class='inline-block mt-6 mb-4 text-4xl font-bold text-gray-700 border-b-2'><code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>.vscode/</code></h2>
    <p class='mb-3'>
      Add a <code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>.vscode/</code> folder containing these files,
    </p>
  <h3 id='vscodeextensionsjson' class='mt-6 mb-2 text-3xl font-bold text-gray-700'><code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>.vscode/extensions.json</code></h3><div class='py-0.5 mb-3 text-sm'><pre><code class='json language-json'>{
    "recommendations": [
        "matklad.rust-analyzer",
        "jnoortheen.nix-ide"
    ]
}</code></pre></div><h3 id='vscodesettingsjson' class='mt-6 mb-2 text-3xl font-bold text-gray-700'><code class='py-0.5 px-1 rounded bg-gray-700 text-sm text-white'>.vscode/settings.json</code></h3><div class='py-0.5 mb-3 text-sm'><pre><code class='json language-json'>{
    "nixEnvSelector.nixFile": "${workspaceRoot}/shell.nix",
    "editor.formatOnSave": true
}</code></pre></div>
    <p class='mb-3'>
      All these files are available in <a href='https://github.com/srid/bouncy' class='text-pink-600 hover:underline' target='_blank' rel='noopener'>this project</a>.
    </p>
  
  <div class='flex items-center justify-center mt-2'>
  <a class='text-gray-300 hover:text-pink-600 text-sm' title='Edit this page on GitHub' href='https://github.com/srid/srid/edit/master/Software/Nix/Nix-ifying Rust projects.md'>
    <svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
      <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'></path>
    </svg>
  </a>
</div>

</article>
              <div class='flex flex-col lg:flex-row lg:space-x-2'>
                
                
  <div class='flex-1 p-4 mt-8 bg-gray-100 rounded'>
    <header class='mb-2 text-xl font-semibold text-gray-500'>Links to this page</header>
    <ul class='space-y-1'>
      
        <li>
          <a class='text-pink-600 mavenLinkBold hover:bg-pink-50' href=''>
            Tristan
          </a>
          
            <div class='mb-4 overflow-auto text-sm text-gray-500'>
  
    <div class='pl-2 mt-2 border-l-2 border-pink-200 hover:border-pink-500'>
      <div><p><a href='rust-nix' class='text-gray-600 font-bold hover:bg-gray-50' data-wikilink-type='WikiLinkEmbed'>Nix-ifying Rust projects</a></p></div>
    </div>
  
</div>
          
        </li>
      
    </ul>
  </div>

              </div>
              
  <section class='flex flex-wrap items-end justify-center my-4 space-x-2 space-y-2 font-mono text-sm'>
    
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-pink-500' href='-/tags/blog/rust/learning'>
        <!-- DoNotFormat -->
        #blog/rust/learning
        <!-- DoNotFormat -->
      </a>
    
  </section>

              <!-- What goes in this file will at the very end of the main div -->
            </main>
          </div>
        </div>
        <footer class='flex items-center justify-center mt-2 mb-8 space-x-4 text-center text-gray-800'>
  
  <div>
    <a href='' title='Go to Home page'>
      <svg xmlns='http://www.w3.org/2000/svg' class='w-6 h-6 hover:text-pink-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'></path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/all' title='View Index'>
      <svg class='w-6 h-6 hover:text-pink-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='https://emanote.srid.ca' target='_blank' title='Generated by Emanote 0.4.9.0'>
      <img class='w-6 h-6 hover:text-pink-700' src='_emanote-static/emanote-logo.svg' />
    </a>
  </div>
  <div>
    <a href='-/tags' title='View tags'>
      <svg class='w-6 h-6 hover:text-pink-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/tasks' title='View tasks'>
      <svg xmlns='http://www.w3.org/2000/svg' class='w-6 h-6 hover:text-pink-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'></path>
      </svg>
    </a>
  </div>
</footer>
      </div>
    </div>
  
</body>

</html>